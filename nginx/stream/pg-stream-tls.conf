# TCP proxy for Postgres with TLS termination at Nginx (advanced).
# Requires Nginx built with stream + ssl_preread/ssl modules.
# Cert paths assume Certbot: /etc/letsencrypt/live/<host>/

# NOTE: This is NOT "HTTPS". It's TLS for a TCP service.
# Clients must connect using a Postgres client that supports SSL.

stream {
  upstream postgres_upstream {
    server 127.0.0.1:5432;
  }

  server {
    listen 5432 ssl;

    ssl_certificate     /etc/letsencrypt/live/pg.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pg.example.com/privkey.pem;

    proxy_pass postgres_upstream;
    proxy_timeout 1h;
    proxy_connect_timeout 5s;
  }
}
